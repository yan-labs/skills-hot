name: Sync Skills Data

on:
  schedule:
    # 每 6 小时同步一次 skills.sh 数据
    - cron: '0 */6 * * *'
    # 每小时同步一次 GitHub stars
    - cron: '30 * * * *'
  workflow_dispatch:
    inputs:
      sync_type:
        description: '同步类型'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - stars
          - skills

jobs:
  sync-skills:
    name: Sync Skills from skills.sh
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */6 * * *' || github.event.inputs.sync_type == 'all' || github.event.inputs.sync_type == 'skills'
    steps:
      - name: Trigger sync endpoint
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "https://skills.hot/api/cron/sync-external-skills")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "❌ Sync failed with status $http_code"
            exit 1
          fi

          echo "✅ Skills sync completed"

  sync-stars:
    name: Sync GitHub Stars
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 * * * *' || github.event.inputs.sync_type == 'all' || github.event.inputs.sync_type == 'stars'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Sync all stars
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: npx tsx scripts/sync-all-stars.ts

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [sync-skills, sync-stars]
    if: failure()
    steps:
      - name: Log failure
        run: |
          echo "⚠️ Sync job failed at $(date)"
          echo "Check the workflow logs for details"
